<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Google Drive Copy Tool - FIXED</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;
      padding:20px;
      display:flex;
      align-items:center;
      justify-content:center
    }
    .container{
      background:#fff;
      max-width:640px;
      width:100%;
      padding:40px;
      border-radius:15px;
      box-shadow:0 10px 40px rgba(0,0,0,.2)
    }
    h1{color:#667eea;margin-bottom:10px;font-size:28px}
    .description{color:#555;margin-bottom:30px;line-height:1.6}
    .google-signin{margin-bottom:30px;padding:20px;background:#f8f9fa;border-radius:10px;text-align:center}
    .google-signin p{margin-bottom:15px;color:#333;font-weight:500}
    .form-group{margin-bottom:18px}
    label{display:block;margin-bottom:6px;font-weight:600;color:#333;font-size:14px}
    input[type=text],input[type=number]{
      width:100%;
      padding:12px;
      border:2px solid #e0e0e0;
      border-radius:8px;
      font-size:14px;
      transition:border-color .3s
    }
    input:focus{outline:none;border-color:#667eea}
    .checkbox-group{
      display:flex;
      align-items:center;
      padding:12px;
      background:#f8f9fa;
      border-radius:8px;
      margin-bottom:15px
    }
    input[type=checkbox]{width:20px;height:20px;margin-right:10px;cursor:pointer}
    button{
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff;
      padding:15px 30px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-size:16px;
      font-weight:600;
      width:100%;
      margin-top:8px;
      transition:all .2s
    }
    button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.4)}
    button:disabled{background:#ccc;cursor:not-allowed;transform:none}
    .status{
      margin-top:20px;
      padding:15px;
      border-radius:8px;
      display:none;
      animation:fadeIn .3s ease
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .status.success{background:#d4edda;color:#155724;border:2px solid #c3e6cb}
    .status.error{background:#f8d7da;color:#721c24;border:2px solid #f5c6cb}
    .status.processing{background:#d1ecf1;color:#0c5460;border:2px solid #bee5eb}
    .signed-in-info{background:#d4edda;padding:15px;border-radius:8px;color:#155724;text-align:center}
    small{color:#999;font-size:12px;display:block;margin-top:5px}
    .loader{
      border:3px solid #f3f3f3;
      border-top:3px solid #667eea;
      border-radius:50%;
      width:40px;height:40px;
      animation:spin 1s linear infinite;
      margin:15px auto
    }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container">
    <h1>üìÅ Google Drive Copy Tool</h1>
    <p class="description">
      Copy shared Google Drive folders to your account with automatic file renaming, recursive subfolder copying, and optional branding PDF.
    </p>
    <div id="googleSignIn" class="google-signin">
      <p>Sign in with your Google account to continue:</p>
      <button id="authBtn">Sign in with Google Drive</button>
    </div>

    <form id="copyForm" style="display:none;">
      <div class="form-group">
        <label for="folderUrl">üìÇ Shared Folder URL *</label>
        <input id="folderUrl" type="text" required placeholder="https://drive.google.com/drive/folders/..." />
        <small>Paste the shared folder URL</small>
      </div>

      <div class="form-group">
        <label for="targetName">üìÅ Target Folder Name</label>
        <input id="targetName" type="text" value="Copied Files" />
      </div>

      <div class="form-group">
        <label for="filePrefix">üè∑Ô∏è File Prefix</label>
        <input id="filePrefix" type="text" value="Doc" />
      </div>

      <div class="checkbox-group">
        <input id="enableNumbering" type="checkbox" checked />
        <label for="enableNumbering">üî¢ Enable File Numbering (001, 002‚Ä¶)</label>
      </div>

      <div class="checkbox-group">
        <input id="processSubfolders" type="checkbox" checked />
        <label for="processSubfolders">üìÇ Process Subfolders Recursively</label>
      </div>

      <div class="form-group">
        <label for="brandingPdfId">üìÑ Branding PDF ID (Optional)</label>
        <input id="brandingPdfId" type="text" placeholder="Google Drive file ID of branding PDF" />
      </div>

      <div class="form-group">
        <label for="maxFileSize">üìè Max File Size (MB)</label>
        <input id="maxFileSize" type="number" value="100" min="1" max="1000" />
      </div>

      <button id="submitBtn" type="submit">üöÄ Start Copying</button>
    </form>

    <div id="status" class="status"></div>
  </div>

  <script>
    // ‚ö†Ô∏è REPLACE THESE VALUES:
    const GOOGLE_CLIENT_ID = "792934718499-rf2odo5otk06q5g8790er0t4ohts7joi.apps.googleusercontent.com";
    const N8N_WEBHOOK_URL = "https://n8n.coolify.grwebdevs.com/webhook/gdrive-copy";

    let accessToken = null;
    let tokenClient;

    function showStatus(type, msg) {
      const s = document.getElementById("status");
      s.className = "status " + type;
      s.innerHTML = msg;
      s.style.display = "block";
    }

    function initOAuth() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: "https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/drive.file",
        callback: (resp) => {
          if (resp.error) {
            showStatus("error", "Authentication failed: " + resp.error);
            console.error("OAuth error:", resp);
            return;
          }
          accessToken = resp.access_token;
          console.log("‚úÖ Access token received");
          document.getElementById("googleSignIn").innerHTML =
            '<div class="signed-in-info">‚úì Signed in! Drive access granted.</div>';
          document.getElementById("copyForm").style.display = "block";
        },
      });
    }

    window.onload = () => {
      if (window.google && google.accounts) {
        console.log("‚úÖ Google Identity Services loaded");
        initOAuth();
      } else {
        showStatus("error","Google Identity Services failed to load. Check internet connection.");
      }
    };

    document.getElementById("authBtn").addEventListener("click", () => {
      if (!tokenClient) {
        showStatus("error","Google client not ready. Refresh page.");
        return;
      }
      console.log("üîë Requesting access token...");
      tokenClient.requestAccessToken({ prompt: "consent" });
    });

    document.getElementById("copyForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!accessToken) {
        showStatus("error","Please sign in first.");
        return;
      }

      const btn = document.getElementById("submitBtn");
      btn.disabled = true;
      showStatus("processing","Processing request... Please wait.");

      // FIXED: Proper data structure that matches what n8n expects
      const payload = {
        access_token: accessToken,
        shared_folder_url: document.getElementById("folderUrl").value.trim(),
        target_folder_name: document.getElementById("targetName").value.trim(),
        file_prefix: document.getElementById("filePrefix").value.trim(),
        add_numbering: document.getElementById("enableNumbering").checked,
        process_subfolders: document.getElementById("processSubfolders").checked,
        branding_pdf_id: document.getElementById("brandingPdfId").value.trim(),
        max_file_size_mb: parseInt(document.getElementById("maxFileSize").value || "100")
      };

      console.log("üì§ Sending payload to n8n:", JSON.stringify(payload, null, 2));

      try {
        const res = await fetch(N8N_WEBHOOK_URL, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(payload)
        });

        console.log("üì• Response status:", res.status);

        const contentType = res.headers.get("content-type");
        let result;

        if (contentType && contentType.includes("application/json")) {
          result = await res.json();
        } else {
          const text = await res.text();
          console.error("Non-JSON response:", text);
          throw new Error("Server returned non-JSON response: " + text.substring(0, 100));
        }

        console.log("üì• Response data:", result);

        if (result.status === "success") {
          showStatus(
            "success",
            `<strong>‚úì Success!</strong><br>
             Files copied: ${result.files_copied || 0}<br>
             Folders processed: ${result.folders_processed || 0}<br>
             ${result.branding_pdf_added?"Branding PDF added ‚úÖ<br>":""}
             <a target="_blank" href="${result.target_folder_url}">üìÅ Open copied folder</a>`
          );
        } else {
          throw new Error(result.message || result.error_code || "Processing failed");
        }
      } catch (err) {
        console.error("‚ùå Error:", err);
        showStatus("error","‚úó Error: " + err.message);
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
